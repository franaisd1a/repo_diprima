format long;
clear all;
% close all;
clc;

%% Iput files 

root_path ='C:\Users\Francesco Diprima\Desktop\SPD_result\fileRDLS\'; 

nm_file={  '41384.00007944.TRK.rdls';
           'deb_260.rdls';
           '41384.00007958.TRK.rdls';
           '41384.00007959.TRK.rdls';
           '41384.00007960.TRK.rdls';
           '41384.00007961.TRK.rdls';
           '41384.00007962.TRK.rdls';
           '41384.00007963.TRK.rdls';
           };

name_file=cell(length(nm_file),1);
for i=1:length(nm_file)
    name_file{i,1}=fullfile(root_path,nm_file{i,1});
end
       
nF=5;%length(name_file);
info=cell(nF,1);
fits_info = cell(nF,1);
rawImg = cell(nF,1);
tableData = cell(nF,1);
stella = cell(nF,1);

%% Read files

for i=1:nF
    info{i,1} = fitsinfo(name_file{i,1});
    fits_info{i,1} = imfinfo(name_file{i,1});
    tableData{i,1} = fitsread(name_file{i,1},'binarytable','Info',info{i,1});
%     fitsdisp(name_file{i,1})
end

%% Coordinate stelle lette dal file risultato di SPD

% File 41384.00007944.TRK
stella{1,1}=[350.315259848932612,-0.188294909350993;
            350.859098296510751,-0.128354547759816;
            350.062716079252482,-0.291391010385708;
            350.615304631909680,-0.247457979978040;
            350.588535571787020,-0.350757220952667;
            350.264659534366388,-0.623875004682928;
            349.903973569574703,-0.766464565198889;
            350.640109071041422,-0.726123782381036;
            350.669113746561607,-0.816396993485948;
            350.930289650033842,-0.885305773020347;            
            350.844426459160275,-0.946942201021276;
            350.965690265228545,-1.051735123727294;
            350.941368279541109,-1.071166030017640;
            349.243060826078818,-1.336686555037996;
            350.662441863931406,-1.152049920676465;
            350.106994417169233,-1.251991949999227;
            348.995365784839805,-1.424753499680834;            
            350.917232684072985,-1.188952392588972;
            351.011611394442980,-1.272714947424761;
            350.940706652983977,-1.318672487684441;
            349.935766976767468,-1.574552672347414;
            350.683633521821378,-1.472268369910090;
            350.014376026265836,-1.604616223836642;
            350.382893314315311,-1.629012159927785;
            349.937800593620750,-1.709990465956337;
            350.140603607888522,-1.725930864492507;
            350.748718086887493,-1.635245382794010;
            349.572170937812984,-1.872201995535948;
            349.617270932917393,-1.898815605829078;
            350.233215940395951,-1.835530020172313;
            349.663911905072837,-1.925420538914972;
            350.517187669628640,-1.825618309871885;
            351.162282974640959,-1.741465788749631;
            351.104743570616449,-1.754950717939828;
            351.064043687553067,-1.781328617052294;
            350.262462373890344,-2.283028880781018;
            349.964684607546985,-2.353756977969567;
            349.774686727389621,-2.398307996953635];

%deb_260
stella{2,1}=[166.183088436775108,-2.492039656068517;
            166.167240895569222,-2.488297292345185;
            166.202455805194091,-2.453181226189948;
            166.120294124377494,-2.440744748714962;
            166.250115396026615,-2.426445512916378;
            166.241043173050258,-2.416070425130488;
            166.061090077730483,-2.402890537926634;
            166.117524348064279,-2.400344748358740;
            166.090111564848485,-2.380018771350147;
            166.129994492221840,-2.372628083096713;
            166.224386074280943,-2.347677783193941;
            166.111472658610950,-2.339808814723067;
            166.087888559033559,-2.321891940490584];    
    
% File 41384.00007958.TRK
stella{3,1}=[
            357.347089637573333,-0.104830127631152;
            356.849727818266672,-0.271284739141010;
            357.308479313718180,-0.261789470176896;
            357.517138905494448,-0.303927329166202;
            357.901369214677402,-0.311442797319528;
            357.619723393255754,-0.517192104360292;
            356.869981423107220,-0.696658002887691;
            356.925837331355353,-0.762961658465555;
            357.054225220686646,-0.775632907882328;            
            356.322870125862039,-0.977478108962168;
            356.726755778870370,-0.983763426269217;
            356.102020682709963,-1.112002320688215;
            356.914103464216737,-1.178520966118918;
            356.207651318455930,-1.351894360784115;
            357.005510604261303,-1.277734182909859;
            358.116794286468462,-1.166427945694887;
            357.407656186252098,-1.315161725049868;
            356.018450062366583,-1.617649679892643;
            356.646720155966364,-1.522952664514025;            
            356.845324007048930,-1.508836165264171;
            357.181900189816929,-1.476697090520430;
            356.755618416053494,-1.586633412618856;
            356.243534394062635,-1.835310697041982;            
            357.064932148655942,-1.800751779570091;
            356.353529503512220,-1.945170308024252;
            357.254069841571891,-1.807910681370072;
            357.691741522591599,-1.742122006123229;            
            356.661619319610850,-2.074765647720184;
            
            356.347701637144496,-2.144887509885595;
            357.789356401357793,-1.936282052092619;
            356.874506950381146,-2.148856386413860;
            357.638479250791477,-2.066235443032032];
        
% File 41384.00007959.TRK
stella{4,1}=[
            358.344897278392580,-0.009935234907002;
            357.054928176322562,-0.775906901366477;
            358.185934171144140,-1.015606518338745;
            356.647980125915865,-1.523271903411752;
            356.846444381289871,-1.509197501178857;
            356.756953165553455,-1.586778656890519;
            358.422230266825466,-1.660830964367813;
            356.662272214799771,-1.989700158017515;
            357.789851001090142,-1.936129664865137;
            356.875543204911082,-2.149075006386821;
            358.660648392596499,-1.946418986750936;
            ];
        
% File 41384.00007960.TRK
stella{5,1}=[        
            358.344872715444524,-0.009840935567643;
            358.896550421065058,-0.179819984608170;
            358.989248174632394,-0.299957958319794;
            358.964659226035735,-0.560622885905174;
            358.179199456568199,-0.808858961191123;
            358.102535463943354,-0.934002308125860;
            358.186312943712039,-1.015745795390266;
            358.117626850263775,-1.166719909352979;
            358.843605665427788,-1.080006848934069;
            357.409411276331809,-1.316055660869032;            
            357.183791701521614,-1.477525517270556;
            358.456988388665366,-1.283875728111437;
            358.293855502267320,-1.570187477099380;
            357.067189909832337,-1.801328570688094;
            357.255794987991578,-1.808485516987055;
            357.693595729476726,-1.742145423121909;
            358.823317986593224,-1.573062837552102;
            358.420985484374853,-1.647143421012484;
            358.422603954285535,-1.660726169257996;
            358.240459570098835,-1.728560710956046;            
            357.790800882555288,-1.936231602191403;
            357.640364043010493,-2.065922648176280;
            358.661043145046278,-1.946099931880709;
            358.853046814477125,-2.110794830476918;
            %lontane
            356.933822522135415,-0.588949779542179;
            356.926849365548037,-0.764235077504244;
            %vicine
            358.240459570098835,-1.728560710956046;
            358.420985484374853,-1.647143421012484;
            %vicine dx
            358.964659226035735,-0.560622885905174
            ];
        
%% Compute difference

val = cell(nF,1);
cleanRes = cell(nF,1);
cleanRes2= cell(nF,1);

for j=1:nF
    for i=1:length(stella{j,1}(:,1))
        diff=[abs(tableData{j,1}{1,1}-stella{j,1}(i,1)), abs(tableData{j,1}{1,2}-stella{j,1}(i,2))];
        
        [rRA,cRA]=find(diff(:,1)==min(diff(:,1)));
        [rDEC,cDEC]=find(diff(:,2)==min(diff(:,2)));
        
        if ((rRA==rDEC) && (cRA==cDEC))
            val{j,1}(i,:)=[min(diff(:,1)),min(diff(:,2))];
            cleanRes{j,1}(i,:)=[tableData{j,1}{1,1}(rRA,cRA)-stella{j,1}(i,1),tableData{j,1}{1,2}(rRA,cRA)-stella{j,1}(i,2)];
            cleanRes2{j,1}(i,:)=[cleanRes{j,1}(i,1),cleanRes{j,1}(i,2)];
        else
            disp('NO');
        end
    end
    [r,c]=find(cleanRes{j,1}(:,1)==0);
    cleanRes{j,1}(r,:) = [];
end

%% Result

res=vertcat(cleanRes{1,1},cleanRes{2,1});

for j=3:nF
    res=vertcat(res,cleanRes{j,1});
end

res=res.*3600;

str_0 = sprintf('Number of stars %d',length(res));
disp(str_0);

meanDiff = mean(res);%.*3600;
str_1 = sprintf('Mean error in arcsec RA=%f DEC=%f', meanDiff(1), meanDiff(2));
disp(str_1);

stdDiff = std(res);%.*3600;
str_2 = sprintf('Standard deviation error in arcsec RA=%f DEC=%f', stdDiff(1), stdDiff(2));
disp(str_2);

if 1
    figure(1)
    subplot(1,2,1);
    % xbins1 = -0.2:0.1:0.15;
    set(gca,'FontSize',18);
    hist(res(:,1));
    xlabel('RA difference [arcsec]','FontSize',26,'FontWeight','bold');
    ylabel('Counts','FontSize',26,'FontWeight','bold');
    subplot(1,2,2);
    % xbins2 = -2.5:0.5:2.5;
    set(gca,'FontSize',18);
    hist(res(:,2));
    xlabel('DEC difference [arcsec]','FontSize',26,'FontWeight','bold');
   
    if 1
        figure(2)
        subplot(1,2,1);
        % xbins1 = -0.2:0.1:0.15;
        set(gca,'FontSize',18);
        hist(cleanRes{1,1}(:,1).*3600);
        xlabel('RA difference [arcsec]','FontSize',26,'FontWeight','bold');
        ylabel('Counts','FontSize',26,'FontWeight','bold');
        subplot(1,2,2);
        % xbins2 = -2.5:0.5:2.5;
        set(gca,'FontSize',18);
        hist(cleanRes{1,1}(:,2).*3600);
        xlabel('DEC difference [arcsec]','FontSize',26,'FontWeight','bold');
        
        figure(3)
        subplot(1,2,1);
        % xbins1 = -0.2:0.1:0.15;
        set(gca,'FontSize',18);
        hist(cleanRes{2,1}(:,1).*3600);
        xlabel('RA difference [arcsec]','FontSize',26,'FontWeight','bold');
        ylabel('Counts','FontSize',26,'FontWeight','bold');
        subplot(1,2,2);
        % xbins2 = -2.5:0.5:2.5;
        set(gca,'FontSize',18);
        hist(cleanRes{2,1}(:,2).*3600);
        xlabel('DEC difference [arcsec]','FontSize',26,'FontWeight','bold');
    end
end