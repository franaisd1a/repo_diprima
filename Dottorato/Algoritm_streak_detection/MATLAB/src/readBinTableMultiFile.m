format long;
clear all;
close all;
clc;

%% Iput files 

name_file={'C:\Users\Francesco Diprima\Desktop\SPD_result\fileRDLS\41384.00007944.TRK.rdls';
           'C:\Users\Francesco Diprima\Desktop\SPD_result\fileRDLS\deb_260.rdls'};

nF=length(name_file);       
info=cell(nF,1);
fits_info = cell(nF,1);
rawImg = cell(nF,1);
tableData = cell(nF,1);
stella = cell(nF,1);

%% Read files

for i=1:nF
    info{i,1} = fitsinfo(name_file{i,1});
    fits_info{i,1} = imfinfo(name_file{i,1});
    tableData{i,1} = fitsread(name_file{i,1},'binarytable','Info',info{i,1});
%     fitsdisp(name_file{i,1})
end

%% Coordinate stelle lette dal file risultato di SPD

% File 41384.00007944.TRK
stella{1,1}=[350.315259848932612,-0.188294909350993;
%             348.847985805695998,-0.422488369034682;
%             349.507893823787640,-0.336959437856298;
            350.859098296510751,-0.128354547759816;
            350.062716079252482,-0.291391010385708;
            350.615304631909680,-0.247457979978040;
%             349.497640030286050,-0.435371767823674;
%             349.492594962638634,-0.501679771345720;
            350.588535571787020,-0.350757220952667;
%             349.967347011744152,-0.468405119591100;
            
%             350.600128041061396,-0.416362269093946;
            350.264659534366388,-0.623875004682928;
%             349.390082642941934,-0.801620112223011;
            349.903973569574703,-0.766464565198889;
            350.640109071041422,-0.726123782381036;
%             349.599791114656455,-0.955684252633676;
            350.669113746561607,-0.816396993485948;
%             348.968750756368252,-1.101218286474411;
%             349.289660401968376,-1.055967889012997;
            350.930289650033842,-0.885305773020347;
            
            350.844426459160275,-0.946942201021276;
%             349.634059432318452,-1.180686144143809;
%             349.091315418072782,-1.293536321800850;
            350.965690265228545,-1.051735123727294;
            350.941368279541109,-1.071166030017640;
            349.243060826078818,-1.336686555037996;
            350.662441863931406,-1.152049920676465;
            350.106994417169233,-1.251991949999227;
            348.995365784839805,-1.424753499680834;
%             349.033669693404988,-1.430826044976370;
            
            350.917232684072985,-1.188952392588972;
            351.011611394442980,-1.272714947424761;
%             349.409775180942233,-1.522295545287037;
%             349.432089845824407,-1.538013267343608;
            350.940706652983977,-1.318672487684441;
            349.935766976767468,-1.574552672347414;
            350.683633521821378,-1.472268369910090;
            350.014376026265836,-1.604616223836642;
%             349.477691243826598,-1.726994602708642;
            350.382893314315311,-1.629012159927785;
            
            349.937800593620750,-1.709990465956337;
%             349.185678412739890,-1.830256607286166;
%             350.827825096222057,-1.592780900752662;
            350.140603607888522,-1.725930864492507;
            350.748718086887493,-1.635245382794010;
            349.572170937812984,-1.872201995535948;
            349.617270932917393,-1.898815605829078;
            350.233215940395951,-1.835530020172313;
            349.663911905072837,-1.925420538914972;
            350.517187669628640,-1.825618309871885;
            
            351.162282974640959,-1.741465788749631;
            351.104743570616449,-1.754950717939828;
%             349.365980465579355,-2.044344454726851;
            351.064043687553067,-1.781328617052294;
%             349.361294619206149,-2.054453485316350;
%             349.762513123432541,-2.108014604871528;
%             349.553756212299959,-2.158028359309980;
%             349.312845963688801,-2.274670597529937;
            350.262462373890344,-2.283028880781018;
            349.964684607546985,-2.353756977969567;
            349.774686727389621,-2.398307996953635];

stella{2,1}=[166.183088436775108,-2.492039656068517;
            166.167240895569222,-2.488297292345185;
            166.202455805194091,-2.453181226189948;
            166.120294124377494,-2.440744748714962;
            166.250115396026615,-2.426445512916378;
            166.241043173050258,-2.416070425130488;
            166.061090077730483,-2.402890537926634;
            166.117524348064279,-2.400344748358740;
            166.090111564848485,-2.380018771350147;
            166.129994492221840,-2.372628083096713;
            166.224386074280943,-2.347677783193941;
            166.111472658610950,-2.339808814723067;
            166.087888559033559,-2.321891940490584];    
    
%% Compute difference

val = cell(nF,1);
cleanRes = cell(nF,1);
cleanRes2= cell(nF,1);

for j=1:nF
    for i=1:length(stella{j,1}(:,1))
        diff=[abs(tableData{j,1}{1,1}-stella{j,1}(i,1)), abs(tableData{j,1}{1,2}-stella{j,1}(i,2))];
        
        [rRA,cRA]=find(diff(:,1)==min(diff(:,1)));
        [rDEC,cDEC]=find(diff(:,2)==min(diff(:,2)));
        
        if ((rRA==rDEC) && (cRA==cDEC))
            val{j,1}(i,:)=[min(diff(:,1)),min(diff(:,2))];
            cleanRes{j,1}(i,:)=[tableData{j,1}{1,1}(rRA,cRA)-stella{j,1}(i,1),tableData{j,1}{1,2}(rRA,cRA)-stella{j,1}(i,2)];
            cleanRes2{j,1}(i,:)=[cleanRes{j,1}(i,1),cleanRes{j,1}(i,2)];
        else
            disp('NO');
        end
    end
    [r,c]=find(cleanRes{j,1}(:,1)==0);
    cleanRes{j,1}(r,:) = [];
end

%% Result

res=vertcat(cleanRes{1,1},cleanRes{2,1});

for j=3:nF
    res=vertcat(res,cleanRes{j,1});
end

res=res.*3600;

str_0 = sprintf('Number of stars %d',length(res));
disp(str_0);

meanDiff = mean(res);%.*3600;
str_1 = sprintf('Mean error in arcsec RA=%f DEC=%f', meanDiff(1), meanDiff(2));
disp(str_1);

stdDiff = std(res);%.*3600;
str_2 = sprintf('Standard deviation error in arcsec RA=%f DEC=%f', stdDiff(1), stdDiff(2));
disp(str_2);

figure(1)
subplot(1,2,1);
% xbins1 = -0.2:0.1:0.15;
set(gca,'FontSize',18);
hist(res(:,1));
xlabel('RA difference [arcsec]','FontSize',26,'FontWeight','bold');
ylabel('Counts','FontSize',26,'FontWeight','bold');
subplot(1,2,2);
% xbins2 = -2.5:0.5:2.5;
set(gca,'FontSize',18);
hist(res(:,2));
xlabel('DEC difference [arcsec]','FontSize',26,'FontWeight','bold');

